# Step 6: Auto-save with Keystroke Data

## Overview
Implement auto-save functionality that saves draft content and keystroke data to the backend every 30 seconds.

## Requirements
- Auto-save draft content every 30 seconds
- Include all keystroke data in the save payload
- Handle network failures gracefully with retry logic
- Show save status indicator (saving, saved, error)
- Implement draft management with unique IDs
- Add conflict resolution for concurrent edits
- Store drafts in database with proper relationships
- Enable draft recovery on page reload

## Technical Specifications
- Use debounced save every 30 seconds from last keystroke
- POST /posts/draft endpoint with content + keystroke data
- Implement exponential backoff for failed saves (1s, 2s, 4s, 8s)
- Store draft ID in localStorage for recovery
- Include timestamp and word count in saves
- Handle large keystroke datasets efficiently

## Implementation Prompt

```
Implement auto-save functionality for the Signify editor that saves draft content and keystroke data every 30 seconds.

Requirements:
1. Auto-save hook (useAutoSave):
   - Debounced save every 30 seconds after last keystroke
   - Trigger immediate save before page unload
   - Save both content and keystroke data
   - Handle save state management (idle, saving, saved, error)
   - Automatic retry with exponential backoff

2. Backend API endpoint:
   - POST /posts/draft
   - Accept: { title?, content, keystrokes, draftId? }
   - Return: { draftId, savedAt, wordCount }
   - Handle large keystroke payloads efficiently
   - Implement proper error responses

3. Save status indicator:
   - Visual indicator showing save state
   - "Saving..." with spinner during save
   - "Saved" with checkmark when complete
   - "Error saving" with retry option
   - Last saved timestamp display

4. Draft management:
   - Generate unique draft IDs (UUIDs)
   - Store draft ID in localStorage
   - Recover drafts on page reload
   - Handle multiple drafts per user
   - Clean up old/abandoned drafts

5. Network failure handling:
   - Detect network connectivity
   - Queue saves when offline
   - Retry with exponential backoff: 1s, 2s, 4s, 8s, 16s
   - Show offline indicator
   - Sync when connection restored

6. Database operations:
   - Upsert draft records (INSERT OR REPLACE)
   - Store keystroke data as JSON blob
   - Efficient queries for draft retrieval
   - Cleanup old keystroke data
   - Handle concurrent saves safely

7. Performance optimization:
   - Compress keystroke data before sending
   - Debounce save operations properly
   - Use requestIdleCallback for non-critical operations
   - Optimize JSON serialization
   - Monitor payload sizes

8. Error handling:
   - Network timeout handling
   - Server error responses
   - Validation errors
   - Storage quota exceeded
   - Graceful degradation

9. User experience:
   - Non-intrusive save indicators
   - Clear error messages with actions
   - Prevent data loss during navigation
   - Smooth loading states
   - Progress indication for large saves

10. Data integrity:
    - Validate keystroke data on save
    - Ensure content matches keystroke events
    - Handle partial save failures
    - Maintain consistency between drafts and keystrokes

Create a reliable auto-save system that preserves user work and keystroke data without disrupting the writing experience.
```

## Deliverables
- Auto-save system with 30-second intervals
- Draft management API endpoints
- Save status UI indicator
- Network failure handling with retry
- Draft recovery on app reload
- Database storage for drafts and keystroke data