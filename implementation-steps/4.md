# Step 4: Keystroke Capture System

## Overview
Implement the core keystroke capture system that records every keypress with precise timestamps.

## Requirements
- Capture all keyboard events (keydown, keyup, input) with millisecond timestamps
- Record character data, event type, and timing information
- Handle special keys (backspace, delete, enter, space)
- Store keystroke data in structured format
- Implement efficient batching to avoid performance issues
- Add keystroke event TypeScript interfaces
- Ensure zero impact on typing performance
- Handle edge cases like rapid typing and modifier keys

## Technical Specifications
- Capture events at 1ms precision using performance.now()
- Batch keystroke events every 100ms to avoid overwhelming the system
- Store events in format: {timestamp, character, eventType, position}
- Handle Unicode characters and emojis properly
- Track cursor position changes
- Implement efficient data structure for storage

## Implementation Prompt

```
Implement a comprehensive keystroke capture system for the Signify editor that records every keypress with precise timing.

Requirements:
1. Keystroke capture hook (useKeystrokeCapture):
   - Monitor all keyboard events: keydown, keyup, input, beforeinput
   - Capture with millisecond precision using performance.now()
   - Record character data, event type, and cursor position
   - Handle special keys: backspace, delete, enter, space, tab
   - Support Unicode characters and emojis

2. Data structure for keystroke events:
   ```typescript
   interface KeystrokeEvent {
     id: string;
     timestamp: number; // performance.now()
     character: string;
     eventType: 'keydown' | 'keyup' | 'input' | 'delete' | 'backspace';
     cursorPosition: number;
     isSpecialKey: boolean;
   }
   ```

3. Performance optimization:
   - Batch events every 100ms to prevent UI blocking
   - Use requestIdleCallback for non-critical processing
   - Efficient data structures (arrays with occasional cleanup)
   - Memory management for long writing sessions
   - Zero impact on typing latency (<1ms)

4. Special key handling:
   - Backspace/Delete: Record as deletion with affected text
   - Enter: Record as line break with proper formatting
   - Tab: Handle indentation (if allowed)
   - Arrow keys: Track cursor movement
   - Modifier keys: Ctrl, Alt, Shift combinations

5. Data validation and cleanup:
   - Filter out system-generated events
   - Handle rapid key repetition
   - Deduplicate similar events
   - Validate character encoding
   - Clean up invalid or test events

6. Integration with editor:
   - Seamless integration with contentEditable
   - No interference with normal typing
   - Proper event listener management
   - Cleanup on component unmount
   - Real-time keystroke display (for debugging)

7. Testing and debugging:
   - Keystroke visualization component
   - Performance monitoring
   - Event accuracy validation
   - Edge case testing (rapid typing, special chars)
   - Memory usage monitoring

Create a robust keystroke capture system that accurately records every aspect of the typing process without impacting user experience.
```

## Deliverables
- Keystroke capture hook with proper event handling
- TypeScript interfaces for keystroke data
- Batching system for performance
- Real-time keystroke data display (for debugging)
- Performance tests ensuring <1ms input lag
- Complete event coverage including special characters